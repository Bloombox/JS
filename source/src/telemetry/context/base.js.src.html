<!DOCTYPE html><html lang="en" class="loading"><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"><title>base.js</title><link href="../../../../dossier.css" rel="stylesheet" type="text/css"><script src="../../../../types.js" defer></script><header><button class="dossier-menu"><i class="material-icons">menu</i></button><form><input type="search" placeholder="Search" tabindex="1"><i class="material-icons">search</i></form></header><nav class="dossier-nav"></nav><div class="content"><main data-page-data="[null,null,null,[&quot;base.js&quot;,&quot;src/telemetry/context/base.js&quot;,[null,&quot;/*&quot;,&quot; * Copyright 2018, Bloombox, LLC. All rights reserved.&quot;,&quot; *&quot;,&quot; * Source and object computer code contained herein is the private intellectual&quot;,&quot; * property of Bloombox, a California Limited Liability Corporation. Use of this&quot;,&quot; * code in source form requires permission in writing before use or the&quot;,&quot; * assembly, distribution, or publishing of derivative works, for commercial&quot;,&quot; * purposes or any other purpose, from a duly authorized officer of Momentum&quot;,&quot; * Ideas Co.&quot;,&quot; *&quot;,&quot; * Unless required by applicable law or agreed to in writing, software&quot;,&quot; * distributed under the License is distributed on an \&quot;AS IS\&quot; BASIS,&quot;,&quot; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&quot;,&quot; * See the License for the specific language governing permissions and&quot;,&quot; * limitations under the License.&quot;,&quot; */&quot;,null,&quot;/**&quot;,&quot; * Bloombox Telemetry: Context&quot;,&quot; *&quot;,&quot; * @fileoverview Provides tools for detecting, specifying, and merging event&quot;,&quot; * contexts.&quot;,&quot; */&quot;,null,&quot;/*global goog */&quot;,null,&quot;goog.require(&#39;bloombox.INTERNAL&#39;);&quot;,&quot;goog.require(&#39;bloombox.VERSION&#39;);&quot;,&quot;goog.require(&#39;bloombox.config.active&#39;);&quot;,null,&quot;goog.require(&#39;bloombox.logging.log&#39;);&quot;,null,&quot;goog.require(&#39;bloombox.menu.Section&#39;);&quot;,null,&quot;goog.require(&#39;bloombox.telemetry.Collection&#39;);&quot;,&quot;goog.require(&#39;bloombox.telemetry.buildBrowserContext&#39;);&quot;,&quot;goog.require(&#39;bloombox.telemetry.buildNativeContext&#39;);&quot;,&quot;goog.require(&#39;bloombox.telemetry.buildWebappContext&#39;);&quot;,null,&quot;goog.require(&#39;bloombox.util.Exportable&#39;);&quot;,&quot;goog.require(&#39;bloombox.util.Serializable&#39;);&quot;,null,&quot;goog.require(&#39;proto.bloombox.schema.analytics.Context&#39;);&quot;,&quot;goog.require(&#39;proto.bloombox.schema.analytics.Scope&#39;);&quot;,&quot;goog.require(&#39;proto.bloombox.schema.analytics.context.APIClient&#39;);&quot;,&quot;goog.require(&#39;proto.bloombox.schema.analytics.context.BrowserDeviceContext&#39;);&quot;,&quot;goog.require(&#39;proto.bloombox.schema.analytics.context.DeviceApplication&#39;);&quot;,&quot;goog.require(&#39;proto.bloombox.schema.analytics.context.DeviceLibrary&#39;);&quot;,&quot;goog.require(&#39;proto.bloombox.schema.analytics.context.NativeDeviceContext&#39;);&quot;,null,&quot;goog.require(&#39;proto.bloombox.schema.identity.UserKey&#39;);&quot;,&quot;goog.require(&#39;proto.bloombox.schema.partner.PartnerDeviceKey&#39;);&quot;,&quot;goog.require(&#39;proto.bloombox.schema.partner.PartnerKey&#39;);&quot;,&quot;goog.require(&#39;proto.bloombox.schema.partner.PartnerLocationKey&#39;);&quot;,&quot;goog.require(&#39;proto.opencannabis.commerce.OrderKey&#39;);&quot;,&quot;goog.require(&#39;proto.opencannabis.structs.VersionSpec&#39;);&quot;,null,&quot;goog.provide(&#39;bloombox.telemetry.Context&#39;);&quot;,&quot;goog.provide(&#39;bloombox.telemetry.ContextException&#39;);&quot;,null,null,&quot;// - Master Context - //&quot;,&quot;/**&quot;,&quot; * Indicates an error happened while building or merging event context.&quot;,&quot; *&quot;,&quot; * @param {string} message Error message for the exception.&quot;,&quot; * @constructor&quot;,&quot; */&quot;,&quot;bloombox.telemetry.ContextException = function ContextException(message) {&quot;,&quot;  /**&quot;,&quot;   * Exception message.&quot;,&quot;   *&quot;,&quot;   * @type {string}&quot;,&quot;   */&quot;,&quot;  this.message = message;&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Gathered event context.&quot;,&quot; *&quot;,&quot; * @param {?bloombox.telemetry.Collection=} opt_collection Collection to file&quot;,&quot; *        this event against.&quot;,&quot; * @param {?string=} opt_partner Partner code to apply to this context.&quot;,&quot; * @param {?string=} opt_location Location code to apply to this context.&quot;,&quot; * @param {?string=} opt_fingerprint Unique device UUID for the active device.&quot;,&quot; * @param {?string=} opt_session Unique session UUID for the active session.&quot;,&quot; * @param {?string=} opt_user Optional. User key to apply to this context.&quot;,&quot; * @param {?string=} opt_device Optional. Device key to apply to this context.&quot;,&quot; *        This is different from the device fingerprint, in that it uniquely&quot;,&quot; *        identifies a known device, rather than being a generic opaque token&quot;,&quot; *        that distinguishes one device context from another.&quot;,&quot; * @param {?bloombox.menu.Section=} opt_section Menu section to specify for the&quot;,&quot; *        hit. Generates a section-scoped commercial event under the hood.&quot;,&quot; *        Optional.&quot;,&quot; * @param {?bloombox.product.Key=} opt_item Item key to specify for the hit.&quot;,&quot; *        Generates an item-scoped commercial event under the hood. Optional.&quot;,&quot; * @param {?string=} opt_order Optional. Order key to apply to this context.&quot;,&quot; * @param {?proto.bloombox.schema.analytics.context.DeviceApplication=} opt_app&quot;,&quot; *        Application context, generated or provided by the partner.&quot;,&quot; * @param {proto.bloombox.schema.analytics.context.BrowserDeviceContext=} opt_browser&quot;,&quot; *        Optional. Explicit browser device context info to override&quot;,&quot; *        whatever globally-gathered info would normally be sent. When&quot;,&quot; *        generating global context, this property is specified as the detected&quot;,&quot; *        info.&quot;,&quot; * @param {proto.bloombox.schema.analytics.context.NativeDeviceContext=} opt_native&quot;,&quot; *        Optional. Explicit native device context, such as information about&quot;,&quot; *        the underlying hardware or display. When generating global context,&quot;,&quot; *        this property is specified as the detected info.&quot;,&quot; * @constructor&quot;,&quot; * @implements {bloombox.util.Exportable&lt;proto.bloombox.schema.analytics.Context&gt;}&quot;,&quot; * @implements {bloombox.util.Serializable}&quot;,&quot; * @throws {bloombox.telemetry.ContextException}&quot;,&quot; * @public&quot;,&quot; */&quot;,&quot;bloombox.telemetry.Context = function(opt_collection,&quot;,&quot;                                      opt_partner,&quot;,&quot;                                      opt_location,&quot;,&quot;                                      opt_fingerprint,&quot;,&quot;                                      opt_session,&quot;,&quot;                                      opt_user,&quot;,&quot;                                      opt_device,&quot;,&quot;                                      opt_section,&quot;,&quot;                                      opt_item,&quot;,&quot;                                      opt_order,&quot;,&quot;                                      opt_app,&quot;,&quot;                                      opt_browser,&quot;,&quot;                                      opt_native) {&quot;,&quot;  /**&quot;,&quot;   * Collection to apply this event to.&quot;,&quot;   *&quot;,&quot;   * @type {?bloombox.telemetry.Collection}&quot;,&quot;   * @public&quot;,&quot;   */&quot;,&quot;  this.collection = opt_collection || null;&quot;,null,&quot;  /**&quot;,&quot;   * Unique fingerprint for this device context. Always present.&quot;,&quot;   *&quot;,&quot;   * @type {?string}&quot;,&quot;   * @public&quot;,&quot;   */&quot;,&quot;  this.fingerprint = opt_fingerprint || null;&quot;,null,&quot;  /**&quot;,&quot;   * Web application context.&quot;,&quot;   *&quot;,&quot;   * @type {?proto.bloombox.schema.analytics.context.DeviceApplication}&quot;,&quot;   */&quot;,&quot;  this.app = opt_app || null;&quot;,null,&quot;  /**&quot;,&quot;   * Session ID for this user/browser session context.&quot;,&quot;   *&quot;,&quot;   * @type {?string}&quot;,&quot;   * @public&quot;,&quot;   */&quot;,&quot;  this.session = opt_session || null;&quot;,null,&quot;  // make us a partner key&quot;,&quot;  let partnerKey;&quot;,&quot;  if (opt_partner) {&quot;,&quot;    partnerKey = new proto.bloombox.schema.partner.PartnerKey();&quot;,&quot;    partnerKey.setCode(opt_partner);&quot;,&quot;  } else {&quot;,&quot;    partnerKey = null;&quot;,&quot;  }&quot;,null,&quot;  // make us a partner key&quot;,&quot;  let locationKey;&quot;,&quot;  if (opt_partner &amp;&amp; opt_location) {&quot;,&quot;    locationKey = new proto.bloombox.schema.partner.PartnerLocationKey();&quot;,&quot;    locationKey.setCode(opt_location);&quot;,&quot;    locationKey.setPartner(partnerKey);&quot;,&quot;  } else if (opt_partner &amp;&amp; opt_location) {&quot;,&quot;    // failure: must specify a partner to specify a location&quot;,&quot;    throw new bloombox.telemetry.ContextException(&quot;,&quot;      &#39;Cannot provide location context without partner context.&#39;);&quot;,&quot;  } else {&quot;,&quot;    // no location-level context&quot;,&quot;    locationKey = null;&quot;,&quot;  }&quot;,null,&quot;  /**&quot;,&quot;   * Location code.&quot;,&quot;   *&quot;,&quot;   * @type {?proto.bloombox.schema.partner.PartnerLocationKey}&quot;,&quot;   * @public&quot;,&quot;   */&quot;,&quot;  this.location = locationKey;&quot;,null,&quot;  // device the device key, if any&quot;,&quot;  let deviceKey;&quot;,&quot;  if (opt_device &amp;&amp; typeof opt_device === &#39;string&#39;) {&quot;,&quot;    deviceKey = new proto.bloombox.schema.partner.PartnerDeviceKey();&quot;,&quot;    deviceKey.setUuid(/** @type {string} */ (opt_device));&quot;,&quot;    deviceKey.setLocation(locationKey);&quot;,&quot;  } else {&quot;,&quot;    deviceKey = null;&quot;,&quot;  }&quot;,null,&quot;  /**&quot;,&quot;   * Known device key or UUID to attribute this event to. Defaults to `null`,&quot;,&quot;   * indicating an anonymous device, like a user&#39;s browser.&quot;,&quot;   *&quot;,&quot;   * @type {?proto.bloombox.schema.partner.PartnerDeviceKey}&quot;,&quot;   * @public&quot;,&quot;   */&quot;,&quot;  this.device = deviceKey;&quot;,null,&quot;  // decode the user key, if any&quot;,&quot;  let user;&quot;,&quot;  if (opt_user) {&quot;,&quot;    let userKey = new proto.bloombox.schema.identity.UserKey();&quot;,&quot;    userKey.setUid(opt_user);&quot;,&quot;    user = userKey;&quot;,&quot;  } else {&quot;,&quot;    user = null;&quot;,&quot;  }&quot;,null,&quot;  /**&quot;,&quot;   * User key to attribute this event to. Defaults to `null`, indicating no&quot;,&quot;   * currently-active user.&quot;,&quot;   *&quot;,&quot;   * @type {?proto.bloombox.schema.identity.UserKey}&quot;,&quot;   * @public&quot;,&quot;   */&quot;,&quot;  this.user = user;&quot;,null,&quot;  // decode the order key, if any&quot;,&quot;  let order;&quot;,&quot;  if (opt_order) {&quot;,&quot;    let orderKey = new proto.opencannabis.commerce.OrderKey();&quot;,&quot;    orderKey.setId(opt_order);&quot;,&quot;    order = orderKey;&quot;,&quot;  } else {&quot;,&quot;    order = null;&quot;,&quot;  }&quot;,null,&quot;  /**&quot;,&quot;   * Menu section to attach to this call, for a section-scoped commercial event.&quot;,&quot;   * Must be specified for an `item` to be attached.&quot;,&quot;   *&quot;,&quot;   * @type {?proto.opencannabis.products.menu.section.Section}&quot;,&quot;   */&quot;,&quot;  this.section = opt_section || null;&quot;,null,&quot;  /**&quot;,&quot;   * Item key to attach to this call, for an item-scoped commercial event.&quot;,&quot;   * Requires that a section be specified.&quot;,&quot;   *&quot;,&quot;   * @type {?proto.opencannabis.base.ProductKey}&quot;,&quot;   */&quot;,&quot;  this.item = opt_item ? opt_item.export() : null;&quot;,null,&quot;  /**&quot;,&quot;   * Order key to attribute this event to. Defaults to `null`, indicating no&quot;,&quot;   * currently-active order.&quot;,&quot;   *&quot;,&quot;   * @type {?proto.opencannabis.commerce.OrderKey}&quot;,&quot;   */&quot;,&quot;  this.order = order;&quot;,null,&quot;  // attach browser context, if any&quot;,&quot;  /**&quot;,&quot;   * Browser context, if any, or `null`.&quot;,&quot;   * @type {?proto.bloombox.schema.analytics.context.BrowserDeviceContext}&quot;,&quot;   * @public&quot;,&quot;   */&quot;,&quot;  this.browser = opt_browser || null;&quot;,null,&quot;  // attach native context, if any&quot;,&quot;  /**&quot;,&quot;   * Native context, if any, or `null`.&quot;,&quot;   * @type {?proto.bloombox.schema.analytics.context.NativeDeviceContext}&quot;,&quot;   * @public&quot;,&quot;   */&quot;,&quot;  this.native = opt_native || null;&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Serialize the protobuf form of a version specification.&quot;,&quot; *&quot;,&quot; * @param {proto.opencannabis.structs.VersionSpec} protob Version spec.&quot;,&quot; * @return {Object} Serialized version spec.&quot;,&quot; */&quot;,&quot;bloombox.telemetry.Context.resolveVersion = function(protob) {&quot;,&quot;  if (protob &amp;&amp; protob.getName())&quot;,&quot;    return {&quot;,&quot;      &#39;name&#39;: protob.getName()&quot;,&quot;    };&quot;,&quot;  return {};&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Serialize the protobuf form of native device context, into an object usable&quot;,&quot; * over-the-wire.&quot;,&quot; *&quot;,&quot; * @param {proto.bloombox.schema.analytics.context.NativeDeviceContext} protob&quot;,&quot; *        Native context.&quot;,&quot; * @return {Object} Serialized native context.&quot;,&quot; */&quot;,&quot;bloombox.telemetry.Context.serializeNativeContext = function(protob) {&quot;,&quot;  return {&quot;,&quot;    &#39;type&#39;: protob.getType(),&quot;,&quot;    &#39;role&#39;: protob.getRole(),&quot;,&quot;    &#39;os&#39;: {&quot;,&quot;      &#39;type&#39;: protob.getOs().getType(),&quot;,&quot;      &#39;version&#39;: (&quot;,&quot;        bloombox.telemetry.Context.resolveVersion(protob.getOs().getVersion()))&quot;,&quot;    },&quot;,&quot;    &#39;screen&#39;: {&quot;,&quot;      &#39;screen&#39;: {&quot;,&quot;        &#39;width&#39;: protob.getScreen().getScreen().getWidth(),&quot;,&quot;        &#39;height&#39;: protob.getScreen().getScreen().getHeight()&quot;,&quot;      },&quot;,&quot;      &#39;viewport&#39;: {&quot;,&quot;        &#39;width&#39;: protob.getScreen().getViewport().getWidth(),&quot;,&quot;        &#39;height&#39;: protob.getScreen().getViewport().getHeight()&quot;,&quot;      },&quot;,&quot;      &#39;density&#39;: protob.getScreen().getDensity(),&quot;,&quot;      &#39;orientation&#39;: protob.getScreen().getOrientation()&quot;,&quot;    }&quot;,&quot;  };&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Serialize the protobuf form of local browser context, into an object usable&quot;,&quot; * over-the-wire.&quot;,&quot; *&quot;,&quot; * @param {proto.bloombox.schema.analytics.context.BrowserDeviceContext} protob&quot;,&quot; *        Browser context.&quot;,&quot; * @return {Object} Serialized browser context.&quot;,&quot; */&quot;,&quot;bloombox.telemetry.Context.serializeBrowserContext = function(protob) {&quot;,&quot;  return {&quot;,&quot;    &#39;browserType&#39;: protob.getBrowserType(),&quot;,&quot;    &#39;version&#39;: bloombox.telemetry.Context.resolveVersion(protob.getVersion()),&quot;,&quot;    &#39;language&#39;: protob.getLanguage(),&quot;,&quot;    &#39;userAgent&#39;: protob.getUserAgent(),&quot;,&quot;    &#39;touchpoints&#39;: protob.getTouchpoints(),&quot;,&quot;    &#39;hardwareConcurrency&#39;: protob.getHardwareConcurrency(),&quot;,&quot;    &#39;colorDepth&#39;: protob.getColorDepth()&quot;,&quot;  };&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Render a protobuf message representing this context, into a native JavaScript&quot;,&quot; * object that is suitable for transmission over-the-wire.&quot;,&quot; *&quot;,&quot; * @param {proto.bloombox.schema.analytics.Context} context Context proto to&quot;,&quot; *        render.&quot;,&quot; * @return {Object} Serialized version of the proto object.&quot;,&quot; * @public&quot;,&quot; */&quot;,&quot;bloombox.telemetry.Context.serializeProto = function(context) {&quot;,&quot;  let baseContext = {};&quot;,&quot;  if (context.getCollection() &amp;&amp; context.getCollection().getName())&quot;,&quot;    baseContext[&#39;collection&#39;] = {&#39;name&#39;: context.getCollection().getName()};&quot;,&quot;  if (context.getFingerprint())&quot;,&quot;    baseContext[&#39;fingerprint&#39;] = context.getFingerprint();&quot;,&quot;  if (context.getGroup())&quot;,&quot;    baseContext[&#39;group&#39;] = context.getGroup();&quot;,null,&quot;  // key contexts&quot;,&quot;  if (context.getUserKey() &amp;&amp; context.getUserKey().getUid())&quot;,&quot;    baseContext[&#39;userKey&#39;] = {&#39;uid&#39;: context.getUserKey().getUid()};&quot;,null,&quot;  // handle partner/commercial scope&quot;,&quot;  if (context.hasScope()) {&quot;,&quot;    let scopeObj = {};&quot;,&quot;    if (context.getScope().getPartner()) {&quot;,&quot;      scopeObj[&#39;partner&#39;] = context.getScope().getPartner();&quot;,&quot;    }&quot;,null,&quot;    if (context.getScope().getCommercial()) {&quot;,&quot;      scopeObj[&#39;commercial&#39;] = context.getScope().getCommercial();&quot;,&quot;    }&quot;,&quot;    if (context.getScope().getOrder()) {&quot;,&quot;      scopeObj[&#39;order&#39;] = context.getScope().getOrder();&quot;,&quot;    }&quot;,&quot;    baseContext[&#39;scope&#39;] = scopeObj;&quot;,&quot;  }&quot;,null,&quot;  // app context&quot;,&quot;  if (context.hasApp()) {&quot;,&quot;    baseContext[&#39;app&#39;] = {&quot;,&quot;      &#39;type&#39;: context.getApp().getType()&quot;,&quot;    };&quot;,null,&quot;    if (context.getApp().hasWeb()) {&quot;,&quot;      let webContext = {&quot;,&quot;        &#39;origin&#39;: context.getApp().getWeb().getOrigin()&quot;,&quot;      };&quot;,&quot;      if (context.getApp().getWeb().getLocation())&quot;,&quot;        webContext[&#39;location&#39;] = context.getApp().getWeb().getLocation();&quot;,&quot;      if (context.getApp().getWeb().getAnchor())&quot;,&quot;        webContext[&#39;anchor&#39;] = context.getApp().getWeb().getAnchor();&quot;,&quot;      if (context.getApp().getWeb().getTitle())&quot;,&quot;        webContext[&#39;title&#39;] = context.getApp().getWeb().getTitle();&quot;,&quot;      if (context.getApp().getWeb().getReferrer())&quot;,&quot;        webContext[&#39;referrer&#39;] = context.getApp().getWeb().getReferrer();&quot;,&quot;      if (context.getApp().getWeb().getProtocol())&quot;,&quot;        webContext[&#39;protocol&#39;] = context.getApp().getWeb().getProtocol();&quot;,&quot;      baseContext[&#39;app&#39;][&#39;web&#39;] = webContext;&quot;,&quot;    }&quot;,&quot;  }&quot;,null,&quot;  // library context&quot;,&quot;  if (context.getLibrary().getVariant()) {&quot;,&quot;    baseContext[&#39;library&#39;] = {&quot;,&quot;      &#39;variant&#39;: context.getLibrary().getVariant(),&quot;,&quot;      &#39;version&#39;: (&quot;,&quot;        bloombox.telemetry.Context.resolveVersion(&quot;,&quot;          context.getLibrary().getVersion()))&quot;,&quot;    };&quot;,&quot;  }&quot;,null,&quot;  // browser context&quot;,&quot;  if (context.hasBrowser()) {&quot;,&quot;    // it has browser context -&gt; serialize it&quot;,&quot;    baseContext[&#39;browser&#39;] = (&quot;,&quot;      bloombox.telemetry.Context.serializeBrowserContext(&quot;,&quot;        context.getBrowser()));&quot;,&quot;  }&quot;,null,&quot;  // native context&quot;,&quot;  if (context.hasNative()) {&quot;,&quot;    // it has native context -&gt; serialize it&quot;,&quot;    baseContext[&#39;native&#39;] = (&quot;,&quot;      bloombox.telemetry.Context.serializeNativeContext(&quot;,&quot;        context.getNative()));&quot;,&quot;  }&quot;,&quot;  return baseContext;&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Render this context object into a JSON-serializable structure suitable for&quot;,&quot; * use over-the-wire.&quot;,&quot; *&quot;,&quot; * @return {Object}&quot;,&quot; * @public&quot;,&quot; */&quot;,&quot;bloombox.telemetry.Context.prototype.serialize = function() {&quot;,&quot;  let baseContext = {};&quot;,null,&quot;  // add collection, if present&quot;,&quot;  if (this.collection)&quot;,&quot;    baseContext[&#39;collection&#39;] = this.collection.serialize();&quot;,null,&quot;  // add fingerprint, if present&quot;,&quot;  if (this.fingerprint)&quot;,&quot;    baseContext[&#39;fingerprint&#39;] = this.fingerprint;&quot;,null,&quot;  // add session key, if present&quot;,&quot;  if (this.session)&quot;,&quot;    baseContext[&#39;group&#39;] = this.session;&quot;,null,&quot;  // add user key, if present&quot;,&quot;  if (this.user)&quot;,&quot;    baseContext[&#39;userKey&#39;] = {&quot;,&quot;      &#39;uid&#39;: this.user.getUid()&quot;,&quot;    };&quot;,null,&quot;  // consider partner context, etc&quot;,&quot;  let partnerScope = /** @type {?string} */ (null);&quot;,null,&quot;  if (this.location) {&quot;,&quot;    if (this.device) {&quot;,&quot;      partnerScope = [&quot;,&quot;        this.location.getPartner().getCode(),&quot;,&quot;        this.location.getCode(),&quot;,&quot;        this.device.getUuid()].join(&#39;/&#39;);&quot;,&quot;    } else {&quot;,&quot;      partnerScope = [&quot;,&quot;        this.location.getPartner().getCode(),&quot;,&quot;        this.device.getUuid()].join(&#39;/&#39;);&quot;,&quot;    }&quot;,&quot;  } else {&quot;,&quot;    if (this.partner) {&quot;,&quot;      partnerScope = this.location.getPartner().getCode();&quot;,&quot;    }&quot;,&quot;  }&quot;,&quot;  if (partnerScope)&quot;,&quot;    baseContext[&#39;scope&#39;] = {&quot;,&quot;      &#39;partner&#39;: partnerScope&quot;,&quot;    };&quot;,null,&quot;  // consider commercial context&quot;,&quot;  if (this.order) {&quot;,&quot;    if (!baseContext[&#39;scope&#39;]) {&quot;,&quot;      baseContext[&#39;scope&#39;] = {&quot;,&quot;        &#39;order&#39;: this.order.getId()&quot;,&quot;      };&quot;,&quot;    }&quot;,&quot;  }&quot;,null,&quot;  if (this.section !== null) {&quot;,&quot;    if (!baseContext[&#39;scope&#39;])&quot;,&quot;      baseContext[&#39;scope&#39;] = {};&quot;,&quot;    let commercialScope = (&quot;,&quot;      &#39;section/&#39; + this.section.toString());&quot;,&quot;    if (this.item !== null) {&quot;,&quot;      // full section + item scope&quot;,&quot;      commercialScope += &#39;/item/&#39; + this.item.getId();&quot;,&quot;    }&quot;,&quot;    baseContext[&#39;scope&#39;][&#39;commercial&#39;] = commercialScope;&quot;,&quot;  }&quot;,null,&quot;  // consider browser context&quot;,&quot;  if (this.browser)&quot;,&quot;    baseContext[&#39;browser&#39;] = (&quot;,&quot;      bloombox.telemetry.Context.serializeBrowserContext(this.browser));&quot;,&quot;  if (this.native)&quot;,&quot;    baseContext[&#39;native&#39;] = (&quot;,&quot;      bloombox.telemetry.Context.serializeNativeContext(this.native));&quot;,&quot;  return baseContext;&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Export the current analytics context as a protobuf message.&quot;,&quot; *&quot;,&quot; * @return {proto.bloombox.schema.analytics.Context}&quot;,&quot; * @public&quot;,&quot; */&quot;,&quot;bloombox.telemetry.Context.prototype.export = function() {&quot;,&quot;  let context = new proto.bloombox.schema.analytics.Context();&quot;,null,&quot;  // attach required client context, and group by session&quot;,&quot;  if (this.fingerprint) context.setFingerprint(this.fingerprint);&quot;,&quot;  if (this.session) context.setGroup(this.session);&quot;,null,&quot;  // attach misc context&quot;,&quot;  if (this.collection) context.setCollection(this.collection.export());&quot;,&quot;  if (this.user) context.setUserKey(this.user);&quot;,null,&quot;  let scope = new proto.bloombox.schema.analytics.Scope();&quot;,null,&quot;  // calculate partner context&quot;,&quot;  if (this.location) {&quot;,&quot;    let basePartnerScope = (&quot;,&quot;      &#39;partner/&#39; + this.location.getPartner().getCode() + &#39;/&#39; +&quot;,&quot;      &#39;location/&#39; + this.location.getCode());&quot;,&quot;    if (this.device) {&quot;,&quot;      // full device-&gt;location-&gt;partner context&quot;,&quot;      scope.setPartner(basePartnerScope + &#39;/&#39; +&quot;,&quot;        &#39;device/&#39; + this.device.getUuid());&quot;,&quot;    } else {&quot;,&quot;      // partner -&gt; location context&quot;,&quot;      scope.setPartner(basePartnerScope);&quot;,&quot;    }&quot;,&quot;    context.setScope(scope);&quot;,&quot;  }&quot;,null,&quot;  // detect application type and version&quot;,&quot;  if (this.app) {&quot;,&quot;    context.setApp(this.app);&quot;,&quot;  } else {&quot;,&quot;    let appContext = (&quot;,&quot;      new proto.bloombox.schema.analytics.context.DeviceApplication());&quot;,&quot;    let webContext = bloombox.telemetry.buildWebappContext();&quot;,&quot;    appContext.setWeb(webContext);&quot;,&quot;    context.setApp(appContext);&quot;,&quot;  }&quot;,null,&quot;// detect library type and version&quot;,&quot;  let libraryVersion = bloombox.VERSION;&quot;,&quot;  let libraryVariant = bloombox.VARIANT;&quot;,null,&quot;  let libObj = new proto.bloombox.schema.analytics.context.DeviceLibrary();&quot;,&quot;  let libVersionObj = new proto.opencannabis.structs.VersionSpec();&quot;,&quot;  libVersionObj.setName(libraryVersion);&quot;,&quot;  libObj.setVersion(libVersionObj);&quot;,&quot;  libObj.setVariant(libraryVariant);&quot;,&quot;  libObj.setClient((&quot;,&quot;    proto.bloombox.schema.analytics.context.APIClient.JAVA_SCRIPT));&quot;,&quot;  context.setLibrary(libObj);&quot;,null,&quot;  // device context&quot;,&quot;  if (this.browser) context.setBrowser(this.browser);&quot;,&quot;  if (this.native) context.setNative(this.native);&quot;,&quot;  return context;&quot;,&quot;};&quot;]]]"></main><footer><div><a href="https://github.com/jleyba/js-dossier">Generated by dossier</a></div></footer></div><script src="../../../../dossier.js" defer></script>