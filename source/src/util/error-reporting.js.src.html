<!DOCTYPE html><html lang="en" class="loading"><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"><title>error-reporting.js</title><link href="../../../dossier.css" rel="stylesheet" type="text/css"><script src="../../../types.js" defer></script><header><button class="dossier-menu"><i class="material-icons">menu</i></button><form><input type="search" placeholder="Search" tabindex="1"><i class="material-icons">search</i></form></header><nav class="dossier-nav"></nav><div class="content"><main data-page-data="[null,null,null,[&quot;error-reporting.js&quot;,&quot;src/util/error-reporting.js&quot;,[null,&quot;/*&quot;,&quot; * Copyright 2016 Google Inc. All Rights Reserved.&quot;,&quot; *&quot;,&quot; * Licensed under the Apache License, Version 2.0 (the \&quot;License\&quot;);&quot;,&quot; * you may not use this file except in compliance with the License.&quot;,&quot; * You may obtain a copy of the License at&quot;,&quot; *&quot;,&quot; *      http://www.apache.org/licenses/LICENSE-2.0&quot;,&quot; *&quot;,&quot; * Unless required by applicable law or agreed to in writing, software&quot;,&quot; * distributed under the License is distributed on an \&quot;AS IS\&quot; BASIS,&quot;,&quot; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&quot;,&quot; * See the License for the specific language governing permissions and&quot;,&quot; * limitations under the License.&quot;,&quot; */&quot;,null,&quot;/**&quot;,&quot; * Stackdriver: Error Reporting&quot;,&quot; *&quot;,&quot; * @fileoverview Provides error reporting functionality with Stackdriver.&quot;,&quot; */&quot;,null,&quot;/*global goog */&quot;,null,&quot;goog.require(&#39;bloombox.DEBUG&#39;);&quot;,&quot;goog.require(&#39;bloombox.logging.error&#39;);&quot;,&quot;goog.require(&#39;bloombox.logging.info&#39;);&quot;,&quot;goog.require(&#39;bloombox.logging.log&#39;);&quot;,null,&quot;goog.provide(&#39;stackdriver.ErrorReporter&#39;);&quot;,&quot;goog.provide(&#39;stackdriver.StackdriverConfig&#39;);&quot;,null,&quot;goog.provide(&#39;stackdriver.errorize&#39;);&quot;,&quot;goog.provide(&#39;stackdriver.notifyFingerprint&#39;);&quot;,&quot;goog.provide(&#39;stackdriver.protect&#39;);&quot;,&quot;goog.provide(&#39;stackdriver.reportError&#39;);&quot;,&quot;goog.provide(&#39;stackdriver.setup&#39;);&quot;,null,null,&quot;/**&quot;,&quot; * URL endpoint of the Stackdriver Error Reporting report API.&quot;,&quot; * @type {string}&quot;,&quot; */&quot;,&quot;let baseAPIUrl = &#39;https://clouderrorreporting.googleapis.com/v1beta1/projects/&#39;;&quot;,null,null,&quot;/**&quot;,&quot; * Stackdriver config payload.&quot;,&quot; *&quot;,&quot; * @public&quot;,&quot; * @typedef {{context: {user: ?string}, targetUrl: ?string, key: string, projectId: string, service: string, version: string, reportUncaughtExceptions: boolean, disabled: boolean}}&quot;,&quot; */&quot;,&quot;stackdriver.StackdriverConfig;&quot;,null,null,&quot;/**&quot;,&quot; * An Error handler that sends errors to the Stackdriver Error Reporting API.&quot;,&quot; *&quot;,&quot; * @param {stackdriver.StackdriverConfig} config - the init config.&quot;,&quot; * @public&quot;,&quot; * @constructor&quot;,&quot; */&quot;,&quot;stackdriver.ErrorReporter = function ErrorReporter(config) {&quot;,&quot;  if (!config.key &amp;&amp; !config.targetUrl) {&quot;,&quot;    throw new Error(&#39;Cannot initialize: No API key or target url provided.&#39;);&quot;,&quot;  }&quot;,&quot;  if (!config.projectId &amp;&amp; !config.targetUrl) {&quot;,&quot;    throw new Error(&#39;Cannot initialize: No project ID or target url provided.&#39;);&quot;,&quot;  }&quot;,null,&quot;  // noinspection JSUnresolvedVariable&quot;,&quot;  if (typeof window[&#39;StackTrace&#39;] === &#39;undefined&#39;) {&quot;,&quot;    // Inform about missing dependency&quot;,&quot;    throw new Error(&#39;make sure you loaded “stackdriver-errors-concat.js” &#39; +&quot;,&quot;      &#39;or “stackdriver-errors-concat.min.js”, or that you imported the &#39; +&quot;,&quot;      &#39;“stacktrace-js” module&#39;);&quot;,&quot;  }&quot;,null,&quot;  /**&quot;,&quot;   * API key to use.&quot;,&quot;   *&quot;,&quot;   * @type {string}&quot;,&quot;   * @public&quot;,&quot;   */&quot;,&quot;  this.apiKey = config.key;&quot;,null,&quot;  /**&quot;,&quot;   * Project ID to use.&quot;,&quot;   *&quot;,&quot;   * @type {string}&quot;,&quot;   * @public&quot;,&quot;   */&quot;,&quot;  this.projectId = config.projectId;&quot;,null,&quot;  /**&quot;,&quot;   * Target URL to use, if any. Overrides other config.&quot;,&quot;   *&quot;,&quot;   * @type {?string}&quot;,&quot;   */&quot;,&quot;  this.targetUrl = config.targetUrl || null;&quot;,null,&quot;  /**&quot;,&quot;   * Global context to include with errors.&quot;,&quot;   *&quot;,&quot;   * @type {Object}&quot;,&quot;   */&quot;,&quot;  this.context = config.context || {};&quot;,null,&quot;  /**&quot;,&quot;   * Service information.&quot;,&quot;   *&quot;,&quot;   * @type {{service: string, version: string}}&quot;,&quot;   */&quot;,&quot;  this.serviceContext = {&quot;,&quot;    &#39;service&#39;: config.service || &#39;web&#39;,&quot;,&quot;    &#39;version&#39;: config.version || &#39;_unknown_&#39;&quot;,&quot;  };&quot;,null,&quot;  /**&quot;,&quot;   * Whether to report uncaught exceptions, or not.&quot;,&quot;   * @type {boolean}&quot;,&quot;   */&quot;,&quot;  this.reportUncaughtExceptions = config.reportUncaughtExceptions !== false;&quot;,null,&quot;  /**&quot;,&quot;   * Killswitch for error reporting.&quot;,&quot;   *&quot;,&quot;   * @type {boolean}&quot;,&quot;   */&quot;,&quot;  this.disabled = config.disabled || false;&quot;,null,&quot;  // Register as global error handler if requested&quot;,&quot;  let that = this;&quot;,&quot;  if (this.reportUncaughtExceptions) {&quot;,&quot;    let oldErrorHandler = window.onerror || (function() {});&quot;,null,&quot;    window[&#39;onerror&#39;] = function(msg, source, lineNumber, columnNumber, error) {&quot;,&quot;      if (error) {&quot;,&quot;        that.report(error);&quot;,&quot;      }&quot;,&quot;      oldErrorHandler(msg, source, lineNumber, columnNumber, error);&quot;,&quot;      return true;&quot;,&quot;    };&quot;,&quot;  }&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Report an error to the Stackdriver Error Reporting API&quot;,&quot; *&quot;,&quot; * @param {Error|String} errObj Error object or message string to report.&quot;,&quot; */&quot;,&quot;stackdriver.ErrorReporter.prototype.report = function(errObj) {&quot;,&quot;  if (this.disabled || !errObj) {&quot;,&quot;    return;&quot;,&quot;  }&quot;,null,&quot;  let payload = {};&quot;,&quot;  payload[&#39;serviceContext&#39;] = this.serviceContext;&quot;,&quot;  payload[&#39;context&#39;] = this.context;&quot;,&quot;  payload[&#39;context&#39;][&#39;httpRequest&#39;] = {&quot;,&quot;    &#39;userAgent&#39;: window.navigator.userAgent,&quot;,&quot;    &#39;url&#39;: window.location.href&quot;,&quot;  };&quot;,null,&quot;  let firstFrameIndex = 0;&quot;,null,&quot;  let err = errObj;&quot;,&quot;  if ((!(err instanceof Error)) &amp;&amp; (&quot;,&quot;    !(typeof err === &#39;string&#39;)) || err instanceof String) {&quot;,&quot;    let errorType = errObj.constructor.name;&quot;,&quot;    let errorMessage = err[&#39;message&#39;];&quot;,&quot;    let errorMessageInfo = null;&quot;,&quot;    let errorName = null;&quot;,&quot;    if (errorMessage) {&quot;,&quot;      if (errorType) {&quot;,&quot;        errorMessageInfo = errorMessage;&quot;,&quot;        errorName = errorType.replace(/\\$\\$/g, &#39;&#39;).replace(/\\$/g, &#39;.&#39;);&quot;,&quot;        if (errorName[0] === &#39;.&#39;) {&quot;,&quot;          errorName = errorName.slice(1);&quot;,&quot;        }&quot;,&quot;      } else {&quot;,&quot;        errorMessageInfo = errorMessage;&quot;,&quot;        errorName = &#39;InternalError&#39;;&quot;,&quot;      }&quot;,&quot;    }&quot;,null,&quot;    if (errorMessageInfo !== null) {&quot;,&quot;      err = new Error(errorMessageInfo);&quot;,&quot;      err.errorName = errorName;&quot;,&quot;      let originalMessage = err.toString().replace(&#39;Error: &#39;, &#39;&#39;);&quot;,&quot;      let newMessage = errorName + &#39;: &#39; + originalMessage;&quot;,&quot;      err.toString = function() {&quot;,&quot;        return newMessage;&quot;,&quot;      };&quot;,&quot;      firstFrameIndex = 2;&quot;,&quot;    }&quot;,&quot;  }&quot;,null,&quot;  if (typeof err === &#39;string&#39; || err instanceof String) {&quot;,&quot;    // Transform the message in an error, use try/catch to make sure the&quot;,&quot;    // stacktrace is populated.&quot;,&quot;    try {&quot;,&quot;      // noinspection ExceptionCaughtLocallyJS&quot;,&quot;      throw new Error(err);&quot;,&quot;    } catch (e) {&quot;,&quot;      err = e;&quot;,&quot;    }&quot;,&quot;    // the first frame when using report() is always this library&quot;,&quot;    firstFrameIndex = 2;&quot;,&quot;  }&quot;,&quot;  let that = this;&quot;,&quot;  // This will use source maps and normalize the stack frames&quot;,&quot;  window[&#39;StackTrace&#39;][&#39;fromError&#39;](err).then(function(stack) {&quot;,&quot;    payload[&#39;message&#39;] = err.toString();&quot;,&quot;    for (let s = firstFrameIndex; s &lt; stack.length; s++) {&quot;,&quot;      payload[&#39;message&#39;] += &#39;\\n&#39;;&quot;,&quot;      // Reconstruct the stack frame to a JS stack frame as expected by Error&quot;,&quot;      // Reporting parsers. stack[s].source should not be used because not&quot;,&quot;      // populated when created from source map.&quot;,&quot;      //&quot;,&quot;      // If functionName or methodName isn&#39;t available &lt;anonymous&gt; will be used&quot;,&quot;      // as the name.&quot;,&quot;      payload[&#39;message&#39;] += [&quot;,&quot;        &#39;    at &#39;, stack[s].getFunctionName() || &#39;&lt;anonymous&gt;&#39;,&quot;,&quot;        &#39; (&#39;, stack[s].getFileName(), &#39;:&#39;, stack[s].getLineNumber(),&quot;,&quot;        &#39;:&#39;, stack[s].getColumnNumber() , &#39;)&#39;].join(&#39;&#39;);&quot;,&quot;    }&quot;,&quot;    bloombox.logging.error(payload[&#39;message&#39;]);&quot;,&quot;    that.sendErrorPayload(payload);&quot;,&quot;  }, function(reason) {&quot;,&quot;    // Failure to extract stacktrace&quot;,&quot;    payload[&#39;message&#39;] = [&quot;,&quot;      &#39;Error extracting stack trace: &#39;, reason, &#39;\\n&#39;,&quot;,&quot;      err.toString(), &#39;\\n&#39;,&quot;,&quot;      &#39;    (&#39;, err[&#39;file&#39;], &#39;:&#39;, err[&#39;line&#39;], &#39;:&#39;, err[&#39;column&#39;], &#39;)&#39;&quot;,&quot;    ].join(&#39;&#39;);&quot;,&quot;    bloombox.logging.error(payload[&#39;message&#39;]);&quot;,&quot;    that.sendErrorPayload(payload);&quot;,&quot;  });&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Send an error payload to the API.&quot;,&quot; *&quot;,&quot; * @param {?Object} payload Payload to send.&quot;,&quot; */&quot;,&quot;stackdriver.ErrorReporter.prototype.sendErrorPayload = function(payload) {&quot;,&quot;  let defaultUrl = baseAPIUrl +&quot;,&quot;    this.projectId + &#39;/events:report?key=&#39; + this.apiKey;&quot;,&quot;  let url = this.targetUrl || defaultUrl;&quot;,null,&quot;  let xhr = new XMLHttpRequest();&quot;,&quot;  xhr.open(&#39;POST&#39;, url, true);&quot;,&quot;  xhr.setRequestHeader(&#39;Content-Type&#39;, &#39;application/json; charset=UTF-8&#39;);&quot;,&quot;  xhr.onloadend = function() {&quot;,&quot;    bloombox.logging.info(&#39;Sent error report.&#39;,&quot;,&quot;      payload);&quot;,&quot;  };&quot;,&quot;  xhr.onerror = function(e) {&quot;,&quot;    bloombox.logging.info(&#39;Failed to send error report.&#39;,&quot;,&quot;      payload);&quot;,&quot;    return e;&quot;,&quot;  };&quot;,&quot;  xhr.send(JSON.stringify(payload));&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Set the user for the current context.&quot;,&quot; *&quot;,&quot; * @param {string} user Unique identifier of the user (can be ID, email or&quot;,&quot; *                 custom token) or `undefined` if not logged in.&quot;,&quot; */&quot;,&quot;stackdriver.ErrorReporter.prototype.setUser = function(user) {&quot;,&quot;  this.context[&#39;user&#39;] = user;&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Global error reporter.&quot;,&quot; *&quot;,&quot; * @type {?stackdriver.ErrorReporter}&quot;,&quot; * @nocollapse&quot;,&quot; * @protected&quot;,&quot; */&quot;,&quot;let _REPORTER = null;&quot;,null,null,&quot;/**&quot;,&quot; * Setup Stackdriver with an active reporter so it can be used later.&quot;,&quot; *&quot;,&quot; * @param {stackdriver.ErrorReporter} reporter Reporter object.&quot;,&quot; * @return {stackdriver.ErrorReporter} The reporter it was handed.&quot;,&quot; * @public&quot;,&quot; */&quot;,&quot;stackdriver.setup = function(reporter) {&quot;,&quot;  _REPORTER = reporter;&quot;,&quot;  return _REPORTER;&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Report an error to the library-global error reporter.&quot;,&quot; *&quot;,&quot; * @param {Error|String} err Error to report.&quot;,&quot; * @param {function(?)=} opt_op Operation the error happened in.&quot;,&quot; * @public&quot;,&quot; */&quot;,&quot;stackdriver.reportError = function(err, opt_op) {&quot;,&quot;  let op = opt_op ? opt_op.name : null;&quot;,&quot;  if (_REPORTER === null) {&quot;,&quot;    // uh oh&quot;,&quot;    bloombox.logging.error(&#39;Unable to report error: not &#39; +&quot;,&quot;      &#39;initialized.&#39;, err);&quot;,&quot;  } else {&quot;,&quot;    // report the error&quot;,&quot;    bloombox.logging.error(&#39;Reporting error encountered in&#39; +&quot;,&quot;      (op ? &#39; protected function \\&#39;&#39; + op + &#39;\\&#39;.&#39; :&quot;,&quot;            &#39; anonymous function.&#39;), err);&quot;,&quot;    _REPORTER.report(err);&quot;,&quot;  }&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Enable an application-level exception as a recordable error.&quot;,&quot; *&quot;,&quot; * @param {function(new:Object, string, string=, number=)} ctor Constructor.&quot;,&quot; * @return {function(string, string=, number=)} Error-ized constructor.&quot;,&quot; */&quot;,&quot;stackdriver.errorize = function(ctor) {&quot;,&quot;  bloombox.logging.log(&#39;Errorizing exception: \\&#39;&#39; +&quot;,&quot;    ctor.name + &#39;\\&#39;...&#39;);&quot;,&quot;  /**&quot;,&quot;   * @type {function(string, string=, number=)}&quot;,&quot;   */&quot;,&quot;  let wrapped = (function(message, fileName, lineNumber) {&quot;,&quot;    let err = new Error(message, fileName, lineNumber);&quot;,&quot;    let instance = new ctor(message, fileName, lineNumber);&quot;,&quot;    Object.setPrototypeOf(err, Object.getPrototypeOf(instance));&quot;,&quot;    err.cause = instance;&quot;,&quot;    if (Error.captureStackTrace) {&quot;,&quot;      Error.captureStackTrace(err, ctor);&quot;,&quot;    }&quot;,&quot;    return err;&quot;,&quot;  });&quot;,&quot;  wrapped.prototype = Object.create(Error.prototype, {&quot;,&quot;    constructor: {&quot;,&quot;      value: Error,&quot;,&quot;      enumerable: false,&quot;,&quot;      writable: false,&quot;,&quot;      configurable: true&quot;,&quot;    }&quot;,&quot;  });&quot;,&quot;  Object.setPrototypeOf(wrapped, Error);&quot;,&quot;  return wrapped;&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Set the unique device fingerprint for error reporting.&quot;,&quot; *&quot;,&quot; * @param {string} fingerprint Fingerprint.&quot;,&quot; */&quot;,&quot;stackdriver.notifyFingerprint = function(fingerprint) {&quot;,&quot;  _REPORTER.setUser(fingerprint);&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Wrap a function so it is protected by Stackdriver Error Reporting.&quot;,&quot; *&quot;,&quot; * @param {T} operation Function to protect.&quot;,&quot; * @return {T} The operation, but wrapped for failure.&quot;,&quot; * @template T&quot;,&quot; * @export&quot;,&quot; */&quot;,&quot;stackdriver.protect = function(operation) {&quot;,&quot;  let op = /** @type {function(*)} */ (operation);&quot;,&quot;  bloombox.logging.log(&#39;Protecting function: \\&#39;&#39; +&quot;,&quot;    op.name + &#39;\\&#39;...&#39;);&quot;,&quot;  let wrapped = (function() {&quot;,&quot;    try {&quot;,&quot;      // execute with given args&quot;,&quot;      return op.bind(arguments[0]).apply(Array.from(arguments).slice(1));&quot;,&quot;    } catch (err) {&quot;,&quot;      if (bloombox.DEBUG) {&quot;,&quot;        debugger;&quot;,&quot;      }&quot;,&quot;      // handle with error reporting, then rethrow&quot;,&quot;      stackdriver.reportError(err, op);&quot;,&quot;      bloombox.logging.error(err);&quot;,&quot;    }&quot;,&quot;  });&quot;,&quot;  return wrapped;&quot;,&quot;};&quot;]]]"></main><footer><div><a href="https://github.com/jleyba/js-dossier">Generated by dossier</a></div></footer></div><script src="../../../dossier.js" defer></script>