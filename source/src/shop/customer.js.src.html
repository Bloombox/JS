<!DOCTYPE html><html lang="en" class="loading"><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"><title>customer.js</title><link href="../../../dossier.css" rel="stylesheet" type="text/css"><script src="../../../types.js" defer></script><header><button class="dossier-menu"><i class="material-icons">menu</i></button><form><input type="search" placeholder="Search" tabindex="1"><i class="material-icons">search</i></form></header><nav class="dossier-nav"></nav><div class="content"><main data-page-data="[null,null,null,[&quot;customer.js&quot;,&quot;src/shop/customer.js&quot;,[null,&quot;/*&quot;,&quot; * Copyright 2018, Bloombox, LLC. All rights reserved.&quot;,&quot; *&quot;,&quot; * Source and object computer code contained herein is the private intellectual&quot;,&quot; * property of Bloombox, a California Limited Liability Corporation. Use of this&quot;,&quot; * code in source form requires permission in writing before use or the&quot;,&quot; * assembly, distribution, or publishing of derivative works, for commercial&quot;,&quot; * purposes or any other purpose, from a duly authorized officer of Momentum&quot;,&quot; * Ideas Co.&quot;,&quot; *&quot;,&quot; * Unless required by applicable law or agreed to in writing, software&quot;,&quot; * distributed under the License is distributed on an \&quot;AS IS\&quot; BASIS,&quot;,&quot; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&quot;,&quot; * See the License for the specific language governing permissions and&quot;,&quot; * limitations under the License.&quot;,&quot; */&quot;,null,&quot;/**&quot;,&quot; * Bloombox Shop: Customer&quot;,&quot; *&quot;,&quot; * @fileoverview Provides a Customer object for ordering/commerce.&quot;,&quot; */&quot;,null,&quot;/*global goog */&quot;,null,&quot;goog.require(&#39;bloombox.identity.ContactInfo&#39;);&quot;,&quot;goog.require(&#39;bloombox.identity.Person&#39;);&quot;,null,&quot;goog.require(&#39;bloombox.logging.log&#39;);&quot;,null,&quot;goog.require(&#39;bloombox.util.Exportable&#39;);&quot;,null,&quot;goog.require(&#39;proto.bloombox.schema.identity.ConsumerProfile&#39;);&quot;,null,&quot;goog.require(&#39;proto.opencannabis.commerce.Customer&#39;);&quot;,&quot;goog.require(&#39;proto.opencannabis.contact.ContactInfo&#39;);&quot;,&quot;goog.require(&#39;proto.opencannabis.contact.EmailAddress&#39;);&quot;,&quot;goog.require(&#39;proto.opencannabis.contact.PhoneNumber&#39;);&quot;,&quot;goog.require(&#39;proto.opencannabis.geo.Address&#39;);&quot;,&quot;goog.require(&#39;proto.opencannabis.geo.Location&#39;);&quot;,&quot;goog.require(&#39;proto.opencannabis.person.Name&#39;);&quot;,null,&quot;goog.provide(&#39;bloombox.shop.Customer&#39;);&quot;,&quot;goog.provide(&#39;bloombox.shop.Customer.fromResponse&#39;);&quot;,&quot;goog.provide(&#39;bloombox.shop.CustomerException&#39;);&quot;,&quot;goog.provide(&#39;bloombox.shop.CustomerName&#39;);&quot;,null,null,null,&quot;/**&quot;,&quot; * Represents an exception that occurred while preparing a customer.&quot;,&quot; *&quot;,&quot; * @param {string} message Exception error message.&quot;,&quot; * @constructor&quot;,&quot; * @export&quot;,&quot; */&quot;,&quot;bloombox.shop.CustomerException = function CustomerException(message) {&quot;,&quot;  this.message = message;&quot;,&quot;};&quot;,null,null,&quot;// -- Customer -- //&quot;,&quot;/**&quot;,&quot; * Specifies a customer&#39;s name.&quot;,&quot; *&quot;,&quot; * @typedef {{firstName: string, lastName: string}}&quot;,&quot; */&quot;,&quot;bloombox.shop.CustomerName;&quot;,null,null,&quot;/**&quot;,&quot; * Specifies a customer attached to an order, who is requesting the order be&quot;,&quot; * fulfilled.&quot;,&quot; *&quot;,&quot; * @param {bloombox.identity.Person} person The human who is this customer.&quot;,&quot; * @param {string} foreignID Foreign system ID, for submitting the order (i.e.&quot;,&quot; *                 Greenbits).&quot;,&quot; * @throws {bloombox.shop.CustomerException} If params provided are invalid.&quot;,&quot; * @implements {bloombox.util.Exportable&lt;proto.opencannabis.commerce.Customer&gt;}&quot;,&quot; * @constructor&quot;,&quot; * @export&quot;,&quot; */&quot;,&quot;bloombox.shop.Customer = function Customer(person,&quot;,&quot;                                           foreignID) {&quot;,&quot;  // validate foreign ID&quot;,&quot;  if (!(typeof foreignID === &#39;string&#39; &amp;&amp; foreignID.length &gt; 0))&quot;,&quot;    throw new bloombox.shop.CustomerException(&quot;,&quot;      &#39;Invalid customer foreign ID. Must be a valid string over length 1.&#39;);&quot;,null,&quot;  /**&quot;,&quot;   * Human being who is this customer.&quot;,&quot;   *&quot;,&quot;   * @type {bloombox.identity.Person}&quot;,&quot;   * @public&quot;,&quot;   */&quot;,&quot;  this.person = person;&quot;,null,&quot;  /**&quot;,&quot;   * Foreign ID for this customer.&quot;,&quot;   *&quot;,&quot;   * @type {string}&quot;,&quot;   * @public&quot;,&quot;   */&quot;,&quot;  this.foreignId = foreignID;&quot;,null,&quot;  /**&quot;,&quot;   * User key for this customer.&quot;,&quot;   *&quot;,&quot;   * @type {?string}&quot;,&quot;   */&quot;,&quot;  this.userKey = null;&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Return the backing person information for this customer.&quot;,&quot; *&quot;,&quot; * @return {bloombox.identity.Person} Customer&#39;s personal information.&quot;,&quot; * @export&quot;,&quot; */&quot;,&quot;bloombox.shop.Customer.prototype.getPerson = function() {&quot;,&quot;  return this.person;&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Retrieve this user&#39;s foreign ID, i.e, the partner-scoped ID for this user.&quot;,&quot; *&quot;,&quot; * @return {string} Partner-level ID for this user account.&quot;,&quot; * @export&quot;,&quot; */&quot;,&quot;bloombox.shop.Customer.prototype.getForeignId = function() {&quot;,&quot;  return this.foreignId;&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Set this customer&#39;s user key value.&quot;,&quot; *&quot;,&quot; * @param {string} key User key to set.&quot;,&quot; * @public&quot;,&quot; */&quot;,&quot;bloombox.shop.Customer.prototype.setUserKey = function(key) {&quot;,&quot;  this.userKey = key;&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Get this customer&#39;s user key value, or `null` if it is unset.&quot;,&quot; *&quot;,&quot; * @return {?string} User key, if set.&quot;,&quot; * @export&quot;,&quot; */&quot;,&quot;bloombox.shop.Customer.prototype.getUserKey = function() {&quot;,&quot;  return this.userKey;&quot;,&quot;};&quot;,null,null,&quot;// noinspection JSUnusedGlobalSymbols&quot;,&quot;/**&quot;,&quot; * Set the customer&#39;s phone number. In some cases, verifying a customer returns&quot;,&quot; * a record that does not include a valid phone number. For submission of PICKUP&quot;,&quot; * or DELIVERY orders, you can add the updated phone number via this method.&quot;,&quot; *&quot;,&quot; * @param {?string} phone Phone number to set, or `null` to clear it. Must be a&quot;,&quot; *        valid E164-formatted telephone number.&quot;,&quot; * @return {bloombox.shop.Customer} For chain-ability.&quot;,&quot; * @throws {bloombox.shop.CustomerException} If the provided value is invalid.&quot;,&quot; * @export&quot;,&quot; */&quot;,&quot;bloombox.shop.Customer.prototype.setPhoneNumber = function(phone) {&quot;,&quot;  if (phone !== null &amp;&amp; (phone[0] !== &#39;+&#39; ||&quot;,&quot;      phone.length &lt; 5 ||&quot;,&quot;      phone.length &gt; 16))&quot;,&quot;    throw new bloombox.shop.CustomerException(&quot;,&quot;      &#39;Invalid phone number: &#39; + phone);&quot;,&quot;  this.person.contactInfo.phoneNumber = phone === null ? null : phone;&quot;,&quot;  return this;&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Return this customer&#39;s phone number, as reported by the underlying customer&quot;,&quot; * contact information.&quot;,&quot; *&quot;,&quot; * @return {?string} Customer&#39;s phone number, or `null` if none is set.&quot;,&quot; * @export&quot;,&quot; */&quot;,&quot;bloombox.shop.Customer.prototype.getPhoneNumber = function() {&quot;,&quot;  return this.person.contactInfo.phoneNumber || null;&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Return this customer&#39;s email address, as reported by the underlying customer&quot;,&quot; * contact information.&quot;,&quot; *&quot;,&quot; * @return {?string} Customer&#39;s email address, or `null` if none is set.&quot;,&quot; * @export&quot;,&quot; */&quot;,&quot;bloombox.shop.Customer.prototype.getEmailAddress = function() {&quot;,&quot;  return this.person.contactInfo.emailAddress || null;&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Build a customer object from a proto customer response.&quot;,&quot; *&quot;,&quot; * @param {Object} proto Protobuf object.&quot;,&quot; * @return {bloombox.shop.Customer} Inflated customer object.&quot;,&quot; * @throws {bloombox.shop.CustomerException} If the name, email, or foreign ID&quot;,&quot; *         could not be resolved.&quot;,&quot; * @public&quot;,&quot; */&quot;,&quot;bloombox.shop.Customer.fromResponse = function(proto) {&quot;,&quot;  if (typeof proto !== &#39;object&#39; || !proto)&quot;,&quot;    throw new bloombox.shop.CustomerException(&quot;,&quot;      &#39;Failed to resolve customer for response.&#39;);&quot;,&quot;  if (!(&#39;customer&#39; in proto))&quot;,&quot;    throw new bloombox.shop.CustomerException(&quot;,&quot;      &#39;Failed to resolve customer.&#39;);&quot;,&quot;  if (!(&#39;foreignId&#39; in proto[&#39;customer&#39;]))&quot;,&quot;    throw new bloombox.shop.CustomerException(&quot;,&quot;      &#39;Failed to resolve foreign ID.&#39;);&quot;,&quot;  if (!(&#39;person&#39; in proto[&#39;customer&#39;]))&quot;,&quot;    throw new bloombox.shop.CustomerException(&quot;,&quot;      &#39;Failed to resolve person.&#39;);&quot;,&quot;  if (!(&#39;name&#39; in proto[&#39;customer&#39;][&#39;person&#39;]))&quot;,&quot;    throw new bloombox.shop.CustomerException(&quot;,&quot;      &#39;Failed to resolve person\\&#39;s name.&#39;);&quot;,&quot;  if (!(&#39;contact&#39; in proto[&#39;customer&#39;][&#39;person&#39;]))&quot;,&quot;    throw new bloombox.shop.CustomerException(&quot;,&quot;      &#39;Failed to resolve contact info.&#39;);&quot;,&quot;  if (!(&#39;email&#39; in proto[&#39;customer&#39;][&#39;person&#39;][&#39;contact&#39;]))&quot;,&quot;    throw new bloombox.shop.CustomerException(&quot;,&quot;      &#39;Failed to resolve email spec.&#39;);&quot;,&quot;  if (!(&#39;address&#39; in proto[&#39;customer&#39;][&#39;person&#39;][&#39;contact&#39;][&#39;email&#39;]))&quot;,&quot;    throw new bloombox.shop.CustomerException(&quot;,&quot;      &#39;Failed to resolve email address.&#39;);&quot;,null,&quot;  // decode user key, if present&quot;,&quot;  let userKey = /** @type {?string|undefined} */ (proto[&#39;customer&#39;][&#39;userKey&#39;]);&quot;,null,&quot;  // decode phone number&quot;,&quot;  let phone = /** @type {?string} */ (&quot;,&quot;    (typeof proto[&#39;customer&#39;][&#39;person&#39;][&#39;contact&#39;][&#39;phone&#39;] === &#39;object&#39; &amp;&amp;&quot;,&quot;      typeof (&quot;,&quot;        proto[&#39;customer&#39;][&#39;person&#39;][&#39;contact&#39;][&#39;phone&#39;][&#39;e164&#39;]) === &#39;string&#39;) ?&quot;,&quot;      proto[&#39;customer&#39;][&#39;person&#39;][&#39;contact&#39;][&#39;phone&#39;][&#39;e164&#39;] : null);&quot;,null,&quot;  bloombox.logging.log(&#39;Resolved customer phone number from response.&#39;, {&quot;,&quot;    &#39;phone&#39;: phone,&quot;,&quot;    &#39;response&#39;: proto[&#39;customer&#39;][&#39;person&#39;][&#39;contact&#39;][&#39;phone&#39;]&quot;,&quot;  });&quot;,null,&quot;  // decode street address&quot;,&quot;  let streetAddress = (&quot;,&quot;    typeof proto[&#39;customer&#39;][&#39;person&#39;][&#39;contact&#39;][&#39;location&#39;] === &#39;object&#39; &amp;&amp;&quot;,&quot;      typeof (&quot;,&quot;      proto[&#39;customer&#39;][&#39;person&#39;][&#39;contact&#39;][&#39;location&#39;][&#39;address&#39;] === &#39;object&#39;&quot;,&quot;      ) ? bloombox.identity.StreetAddress.fromResponse((&quot;,&quot;        proto[&#39;customer&#39;][&#39;person&#39;][&#39;contact&#39;][&#39;location&#39;][&#39;address&#39;])) : null);&quot;,null,&quot;  bloombox.logging.log(&#39;Resolved customer address from response.&#39;, {&quot;,&quot;    &#39;address&#39;: streetAddress,&quot;,&quot;    &#39;response&#39;: proto[&#39;customer&#39;][&#39;person&#39;][&#39;contact&#39;][&#39;location&#39;]&quot;,&quot;  });&quot;,null,&quot;  // inflate contact info&quot;,&quot;  let contactInfo = new bloombox.identity.ContactInfo(&quot;,&quot;    proto[&#39;customer&#39;][&#39;person&#39;][&#39;contact&#39;][&#39;email&#39;][&#39;address&#39;],&quot;,&quot;    phone,&quot;,&quot;    streetAddress);&quot;,null,&quot;  let dobData = /** @type {?} */ (proto[&#39;customer&#39;][&#39;person&#39;][&#39;dateOfBirth&#39;]);&quot;,null,&quot;  let dobValue = /** @type {?string} */ (null);&quot;,&quot;  if (typeof dobData === &#39;string&#39;) {&quot;,&quot;    // it&#39;s a raw ISO8601 date string&quot;,&quot;    dobValue = dobData;&quot;,&quot;  } else if (typeof dobData === &#39;object&#39;) {&quot;,&quot;    // it&#39;s an ISO8601-style string probably&quot;,&quot;    if (dobData[&#39;iso8601&#39;])&quot;,&quot;      dobValue = dobData[&#39;iso8601&#39;];&quot;,&quot;  }&quot;,null,&quot;  let person = new bloombox.identity.Person(&quot;,&quot;    proto[&#39;customer&#39;][&#39;person&#39;][&#39;name&#39;][&#39;firstName&#39;],&quot;,&quot;    proto[&#39;customer&#39;][&#39;person&#39;][&#39;name&#39;][&#39;lastName&#39;],&quot;,&quot;    contactInfo,&quot;,&quot;    dobValue);&quot;,null,&quot;  let customer = new bloombox.shop.Customer(&quot;,&quot;    person,&quot;,&quot;    proto[&#39;customer&#39;][&#39;foreignId&#39;]);&quot;,null,&quot;  if (typeof userKey === &#39;string&#39;)&quot;,&quot;    customer.setUserKey(userKey);&quot;,&quot;  return customer;&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Export this customer to a proto we can use in an RPC.&quot;,&quot; *&quot;,&quot; * @return {proto.opencannabis.commerce.Customer} Customer proto.&quot;,&quot; * @throws {bloombox.shop.CustomerException} If data is missing/invalid.&quot;,&quot; * @public&quot;,&quot; */&quot;,&quot;bloombox.shop.Customer.prototype.export = function() {&quot;,&quot;  let customer = new proto.opencannabis.commerce.Customer();&quot;,null,&quot;  // prep customer name&quot;,&quot;  let name = new proto.opencannabis.person.Name();&quot;,&quot;  name.setFirstName(this.person.name.getFirstName());&quot;,&quot;  name.setLastName(this.person.name.getLastName());&quot;,null,&quot;  let contactInfo = new proto.opencannabis.contact.ContactInfo();&quot;,&quot;  let contactLocation = new proto.opencannabis.geo.Location();&quot;,&quot;  let contactAddress = new proto.opencannabis.geo.Address();&quot;,null,&quot;  // prep street address, if available&quot;,&quot;  if (this.person.contactInfo.streetAddress !== null) {&quot;,&quot;    contactAddress.setFirstLine(&quot;,&quot;      this.person.contactInfo.streetAddress.firstLine);&quot;,&quot;    if (this.person.contactInfo.streetAddress.secondLine !== null)&quot;,&quot;      contactAddress.setSecondLine(&quot;,&quot;        /** @type {string} */ (&quot;,&quot;          this.person.contactInfo.streetAddress.secondLine));&quot;,&quot;    contactAddress.setCity(this.person.contactInfo.streetAddress.city);&quot;,&quot;    contactAddress.setState(this.person.contactInfo.streetAddress.state);&quot;,&quot;    contactAddress.setZipcode(this.person.contactInfo.streetAddress.zip);&quot;,&quot;    contactAddress.setCountry(this.person.contactInfo.streetAddress.country);&quot;,&quot;    contactLocation.setAddress(contactAddress);&quot;,&quot;    contactInfo.setLocation(contactLocation);&quot;,&quot;  }&quot;,null,&quot;  // prep contact info&quot;,&quot;  let emailAddress = new proto.opencannabis.contact.EmailAddress();&quot;,null,&quot;  // casting this because orders require an email address&quot;,&quot;  if (!(typeof this.person.contactInfo.emailAddress === &#39;string&#39;) ||&quot;,&quot;      (this.person.contactInfo.emailAddress.length &lt; 3) ||&quot;,&quot;      (this.person.contactInfo.emailAddress.split(&#39;@&#39;).length !== 2))&quot;,&quot;    throw new bloombox.shop.CustomerException(&quot;,&quot;      &#39;Must provide a valid email address.&#39;);&quot;,&quot;  emailAddress.setAddress(/** @type {string} */ (&quot;,&quot;    this.person.contactInfo.emailAddress));&quot;,&quot;  contactInfo.setEmail(emailAddress);&quot;,null,&quot;  // casting this because orders require a phone number&quot;,&quot;  if (this.person.contactInfo.phoneNumber === null) {&quot;,&quot;    throw new bloombox.shop.CustomerException(&quot;,&quot;      &#39;Must provide a valid phone number.&#39;);&quot;,&quot;  }&quot;,&quot;  let phoneNumber = new proto.opencannabis.contact.PhoneNumber();&quot;,&quot;  phoneNumber.setE164(&quot;,&quot;    /** @type {string} */ (this.person.contactInfo.phoneNumber));&quot;,&quot;  contactInfo.setPhone(phoneNumber);&quot;,null,&quot;  // set foreign ID&quot;,&quot;  customer.setForeignId(this.foreignId);&quot;,&quot;  return customer;&quot;,&quot;};&quot;]]]"></main><footer><div><a href="https://github.com/jleyba/js-dossier">Generated by dossier</a></div></footer></div><script src="../../../dossier.js" defer></script>