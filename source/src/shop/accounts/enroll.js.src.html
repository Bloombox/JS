<!DOCTYPE html><html lang="en" class="loading"><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"><title>enroll.js</title><link href="../../../../dossier.css" rel="stylesheet" type="text/css"><script src="../../../../types.js" defer></script><header><button class="dossier-menu"><i class="material-icons">menu</i></button><form><input type="search" placeholder="Search" tabindex="1"><i class="material-icons">search</i></form></header><nav class="dossier-nav"></nav><div class="content"><main data-page-data="[null,null,null,[&quot;enroll.js&quot;,&quot;src/shop/accounts/enroll.js&quot;,[null,&quot;/*&quot;,&quot; * Copyright 2018, Bloombox, LLC. All rights reserved.&quot;,&quot; *&quot;,&quot; * Source and object computer code contained herein is the private intellectual&quot;,&quot; * property of Bloombox, a California Limited Liability Corporation. Use of this&quot;,&quot; * code in source form requires permission in writing before use or the&quot;,&quot; * assembly, distribution, or publishing of derivative works, for commercial&quot;,&quot; * purposes or any other purpose, from a duly authorized officer of Momentum&quot;,&quot; * Ideas Co.&quot;,&quot; *&quot;,&quot; * Unless required by applicable law or agreed to in writing, software&quot;,&quot; * distributed under the License is distributed on an \&quot;AS IS\&quot; BASIS,&quot;,&quot; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&quot;,&quot; * See the License for the specific language governing permissions and&quot;,&quot; * limitations under the License.&quot;,&quot; */&quot;,null,&quot;/**&quot;,&quot; * Bloombox: Enroll&quot;,&quot; *&quot;,&quot; * @fileoverview Provides a method to enroll a new customer.&quot;,&quot; */&quot;,null,&quot;/*global goog */&quot;,null,&quot;goog.provide(&#39;bloombox.shop.enroll.EnrollCallback&#39;);&quot;,&quot;goog.provide(&#39;bloombox.shop.enroll.Enrollment&#39;);&quot;,&quot;goog.provide(&#39;bloombox.shop.enroll.EnrollmentException&#39;);&quot;,null,&quot;goog.require(&#39;bloombox.config.active&#39;);&quot;,null,&quot;goog.require(&#39;bloombox.identity.ConsumerProfile&#39;);&quot;,&quot;goog.require(&#39;bloombox.identity.ContactInfo&#39;);&quot;,&quot;goog.require(&#39;bloombox.identity.DoctorRec&#39;);&quot;,&quot;goog.require(&#39;bloombox.identity.EnrollmentSource&#39;);&quot;,&quot;goog.require(&#39;bloombox.identity.ID&#39;);&quot;,&quot;goog.require(&#39;bloombox.identity.Person&#39;);&quot;,&quot;goog.require(&#39;bloombox.identity.PersonException&#39;);&quot;,&quot;goog.require(&#39;bloombox.identity.StreetAddress&#39;);&quot;,null,&quot;goog.require(&#39;bloombox.logging.error&#39;);&quot;,&quot;goog.require(&#39;bloombox.logging.log&#39;);&quot;,&quot;goog.require(&#39;bloombox.logging.warn&#39;);&quot;,null,&quot;goog.require(&#39;bloombox.shop.Customer&#39;);&quot;,null,&quot;goog.require(&#39;bloombox.shop.Routine&#39;);&quot;,&quot;goog.require(&#39;bloombox.shop.rpc.ShopRPC&#39;);&quot;,null,&quot;goog.require(&#39;bloombox.telemetry.event&#39;);&quot;,&quot;goog.require(&#39;bloombox.telemetry.notifyUserID&#39;);&quot;,null,&quot;goog.require(&#39;proto.bloombox.schema.identity.EnrollmentSource&#39;);&quot;,&quot;goog.require(&#39;proto.bloombox.schema.services.shop.v1.EnrollMember&#39;);&quot;,&quot;goog.require(&#39;proto.bloombox.schema.services.shop.v1.EnrollmentError&#39;);&quot;,null,null,&quot;/**&quot;,&quot; * Callback function type definition for enroll RPCs.&quot;,&quot; *&quot;,&quot; * @typedef {function(boolean, ?proto.bloombox.schema.services.shop.v1.EnrollmentError, ?bloombox.shop.Customer)}&quot;,&quot; */&quot;,&quot;bloombox.shop.enroll.EnrollCallback;&quot;,null,null,&quot;/**&quot;,&quot; * Represents an exception that occurred while preparing or submitting&quot;,&quot; * a verification request.&quot;,&quot; *&quot;,&quot; * @param {string} message Exception error message.&quot;,&quot; * @constructor&quot;,&quot; * @export&quot;,&quot; */&quot;,&quot;bloombox.shop.enroll.EnrollmentException = function VerifyException(message) {&quot;,&quot;  this.message = message;&quot;,&quot;};&quot;,null,null,&quot;// -- Enrollment -- //&quot;,null,&quot;/**&quot;,&quot; * Request to enroll a new user, including their driver&#39;s license, doctor&#39;s&quot;,&quot; * recommendation for cannabis, contact info, and account password.&quot;,&quot; *&quot;,&quot; * @param {bloombox.identity.EnrollmentSource} source Source type for this&quot;,&quot; *        enrollment.&quot;,&quot; * @param {string} channel Channel source identifier for this enrollment.&quot;,&quot; * @param {bloombox.identity.Person} person Person enrolling for the account.&quot;,&quot; * @param {?bloombox.identity.DoctorRec} rec Person&#39;s doctor rec.&quot;,&quot; * @param {bloombox.identity.ID} license Person&#39;s driver&#39;s license or other ID.&quot;,&quot; * @param {?string=} opt_password User&#39;s password. Optional.&quot;,&quot; * @param {?bloombox.identity.ConsumerProfile=} opt_profile Consumer profile.&quot;,&quot; * @constructor&quot;,&quot; * @export&quot;,&quot; */&quot;,&quot;bloombox.shop.enroll.Enrollment = function Enrollment(source,&quot;,&quot;                                                      channel,&quot;,&quot;                                                      person,&quot;,&quot;                                                      rec,&quot;,&quot;                                                      license,&quot;,&quot;                                                      opt_password,&quot;,&quot;                                                      opt_profile) {&quot;,&quot;  /**&quot;,&quot;   * User ID resulting from this enrollment, once it has completed.&quot;,&quot;   *&quot;,&quot;   * @type {?string}&quot;,&quot;   * @package&quot;,&quot;   */&quot;,&quot;  this.id = null;&quot;,null,&quot;  /**&quot;,&quot;   * User key resulting from this enrollment, once it has completed.&quot;,&quot;   *&quot;,&quot;   * @type {?string}&quot;,&quot;   * @package&quot;,&quot;   */&quot;,&quot;  this.key = null;&quot;,null,&quot;  /**&quot;,&quot;   * Foreign ID resulting from this enrollment, once it has completed.&quot;,&quot;   *&quot;,&quot;   * @type {?string}&quot;,&quot;   * @package&quot;,&quot;   */&quot;,&quot;  this.foreignId = null;&quot;,null,&quot;  /**&quot;,&quot;   * Enrollment source.&quot;,&quot;   *&quot;,&quot;   * @export&quot;,&quot;   * @type {bloombox.identity.EnrollmentSource}&quot;,&quot;   */&quot;,&quot;  this.source = source;&quot;,null,&quot;  /**&quot;,&quot;   * Channel source identifier.&quot;,&quot;   *&quot;,&quot;   * @export&quot;,&quot;   * @type {string}&quot;,&quot;   */&quot;,&quot;  this.channel = channel;&quot;,null,&quot;  /**&quot;,&quot;   * Person who is enrolling.&quot;,&quot;   *&quot;,&quot;   * @export&quot;,&quot;   * @type {bloombox.identity.Person}&quot;,&quot;   */&quot;,&quot;  this.person = person;&quot;,null,&quot;  /**&quot;,&quot;   * Doctor&#39;s recommendation.&quot;,&quot;   *&quot;,&quot;   * @export&quot;,&quot;   * @type {?bloombox.identity.DoctorRec}&quot;,&quot;   */&quot;,&quot;  this.doctorRec = rec;&quot;,null,&quot;  /**&quot;,&quot;   * Person&#39;s driver&#39;s license.&quot;,&quot;   *&quot;,&quot;   * @export&quot;,&quot;   * @type {bloombox.identity.ID}&quot;,&quot;   */&quot;,&quot;  this.license = license;&quot;,null,&quot;  /**&quot;,&quot;   * Base64-encoded account password, if provided.&quot;,&quot;   *&quot;,&quot;   * @public&quot;,&quot;   * @type {?string}&quot;,&quot;   */&quot;,&quot;  this.password = (opt_password !== null &amp;&amp; opt_password !== undefined) ? btoa(&quot;,&quot;      /** @type {string} */ (opt_password)) : null;&quot;,null,&quot;  /**&quot;,&quot;   * User&#39;s profile. Defaults to null.&quot;,&quot;   *&quot;,&quot;   * @export&quot;,&quot;   * @type {?bloombox.identity.ConsumerProfile}&quot;,&quot;   */&quot;,&quot;  this.profile = opt_profile || null;&quot;,null,&quot;  /**&quot;,&quot;   * Dry-run status for this enrollment. When truthy, this will prevent the&quot;,&quot;   * subject user from being written to any persistence or external systems.&quot;,&quot;   * The enrollment is still verified and logged, though, for testing.&quot;,&quot;   *&quot;,&quot;   * @export&quot;,&quot;   * @type {boolean}&quot;,&quot;   */&quot;,&quot;  this.dryRun = false;&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Return this enrollment&#39;s resulting user ID.&quot;,&quot; *&quot;,&quot; * @return {?string} User ID.&quot;,&quot; * @export&quot;,&quot; */&quot;,&quot;bloombox.shop.enroll.Enrollment.prototype.getId = function() {&quot;,&quot;  return this.id;&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Set this enrollment&#39;s resulting user ID.&quot;,&quot; *&quot;,&quot; * @param {string} id User ID to set.&quot;,&quot; * @package&quot;,&quot; */&quot;,&quot;bloombox.shop.enroll.Enrollment.prototype.setId = function(id) {&quot;,&quot;  this.id = id;&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Return this enrollment&#39;s resulting user key.&quot;,&quot; *&quot;,&quot; * @return {?string} User key.&quot;,&quot; * @export&quot;,&quot; */&quot;,&quot;bloombox.shop.enroll.Enrollment.prototype.getKey = function() {&quot;,&quot;  return this.key;&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Set this enrollment&#39;s resulting user key.&quot;,&quot; *&quot;,&quot; * @param {string} key Resulting user key.&quot;,&quot; * @package&quot;,&quot; */&quot;,&quot;bloombox.shop.enroll.Enrollment.prototype.setKey = function(key) {&quot;,&quot;  this.key = key;&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Set this user&#39;s resulting foreign ID.&quot;,&quot; *&quot;,&quot; * @param {string} foreignId This user&#39;s foreign ID.&quot;,&quot; * @package&quot;,&quot; */&quot;,&quot;bloombox.shop.enroll.Enrollment.prototype.setForeignId = function(foreignId) {&quot;,&quot;  this.foreignId = foreignId;&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Return this enrollment&#39;s resulting foreign ID.&quot;,&quot; *&quot;,&quot; * @return {?string} User&#39;s foreign ID for the currently-active partner scope.&quot;,&quot; * @export&quot;,&quot; */&quot;,&quot;bloombox.shop.enroll.Enrollment.prototype.getForeignId = function() {&quot;,&quot;  return this.foreignId;&quot;,&quot;};&quot;,null,null,&quot;// noinspection JSUnusedGlobalSymbols&quot;,&quot;/**&quot;,&quot; * Activate dry run mode.&quot;,&quot; *&quot;,&quot; * @return {bloombox.shop.enroll.Enrollment} Self, for chain-ability.&quot;,&quot; * @export&quot;,&quot; */&quot;,&quot;bloombox.shop.enroll.Enrollment.prototype.enableDryRun = function() {&quot;,&quot;  this.dryRun = true;&quot;,&quot;  return this;&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Submit analytics data after an enrollment request has been sent to the server&quot;,&quot; * and indicate whether it was successful or not.&quot;,&quot; *&quot;,&quot; * @param {?string} key Key for the resulting user, if enrollment succeeded.&quot;,&quot; * @param {?string} foreignId Foreign ID for the user, if enrollment succeeded.&quot;,&quot; * @param {?proto.bloombox.schema.services.shop.v1.EnrollmentError=} opt_error&quot;,&quot; *        Error that was reported by the server, if any.&quot;,&quot; * @param {?number=} opt_status Status reported by the server, if the enrollment&quot;,&quot; *        was rejected.&quot;,&quot; */&quot;,&quot;bloombox.shop.enroll.Enrollment.prototype.sendAnalytics = function(key,&quot;,&quot;                                                                   foreignId,&quot;,&quot;                                                                   opt_error,&quot;,&quot;                                                                   opt_status) {&quot;,&quot;  bloombox.telemetry.event(&quot;,&quot;    bloombox.telemetry.InternalCollection.ENROLLMENT,&quot;,&quot;    {&#39;action&#39;: opt_error ? &#39;error&#39; : &#39;enroll&#39;,&quot;,&quot;     &#39;status&#39;: opt_status ? opt_status : 200,&quot;,&quot;     &#39;customer&#39;: {&#39;foreignId&#39;: this.foreignId.trim()},&quot;,&quot;     &#39;enrollment&#39;: {&quot;,&quot;        &#39;key&#39;: this.key.trim(),&quot;,&quot;        &#39;channel&#39;: this.channel,&quot;,&quot;        &#39;source&#39;: this.source}}).send();&quot;,&quot;};&quot;,null,null,&quot;/**&quot;,&quot; * Send the RPC to enroll a user.&quot;,&quot; *&quot;,&quot; * @param {bloombox.shop.enroll.EnrollCallback} callback Enrollment callback.&quot;,&quot; * @export&quot;,&quot; */&quot;,&quot;bloombox.shop.enroll.Enrollment.prototype.send = function(callback) {&quot;,&quot;  let config = bloombox.config.active();&quot;,&quot;  let partner = config.partner;&quot;,&quot;  let location = config.location;&quot;,null,&quot;  if (!partner || !location) {&quot;,&quot;    bloombox.logging.error(&#39;Partner or location code is not defined.&#39;);&quot;,&quot;    return;&quot;,&quot;  }&quot;,null,&quot;  let rawObject = {&quot;,&quot;    &#39;person&#39;: {&quot;,&quot;      &#39;name&#39;: {&quot;,&quot;        &#39;firstName&#39;: this.person.name.getFirstName(),&quot;,&quot;        &#39;lastName&#39;: this.person.name.getLastName()&quot;,&quot;      },&quot;,&quot;      &#39;contact&#39;: {&quot;,&quot;        &#39;email&#39;: {&#39;address&#39;: this.person.contactInfo.emailAddress},&quot;,&quot;        &#39;phone&#39;: {&#39;e164&#39;: this.person.contactInfo.phoneNumber},&quot;,&quot;        &#39;location&#39;: {&quot;,&quot;          &#39;address&#39;: {&quot;,&quot;            &#39;firstLine&#39;: this.person.contactInfo.streetAddress.firstLine,&quot;,&quot;            &#39;secondLine&#39;: this.person.contactInfo.streetAddress.secondLine,&quot;,&quot;            &#39;city&#39;: this.person.contactInfo.streetAddress.city,&quot;,&quot;            &#39;state&#39;: this.person.contactInfo.streetAddress.state,&quot;,&quot;            &#39;zipcode&#39;: this.person.contactInfo.streetAddress.zip,&quot;,&quot;            &#39;country&#39;: this.person.contactInfo.streetAddress.country&quot;,&quot;          }&quot;,&quot;        }&quot;,&quot;      },&quot;,&quot;      &#39;dateOfBirth&#39;: {&quot;,&quot;        &#39;iso8601&#39;: this.person.dateOfBirth.getIso8601()&quot;,&quot;      }&quot;,&quot;    },&quot;,&quot;    &#39;source&#39;: this.source,&quot;,&quot;    &#39;channel&#39;: this.channel,&quot;,&quot;    &#39;governmentId&#39;: {&quot;,&quot;      &#39;id&#39;: this.license.id,&quot;,&quot;      &#39;expireDate&#39;: {&quot;,&quot;        &#39;iso8601&#39;: this.license.expirationDate.getIso8601()&quot;,&quot;      },&quot;,&quot;      &#39;birthDate&#39;: {&quot;,&quot;        &#39;iso8601&#39;: this.license.birthDate.getIso8601()&quot;,&quot;      },&quot;,&quot;      &#39;license&#39;: {&quot;,&quot;        &#39;jurisdiction&#39;: this.license.jurisdiction.toUpperCase()&quot;,&quot;      }&quot;,&quot;    }&quot;,&quot;  };&quot;,null,&quot;  if (this.doctorRec !== null) {&quot;,&quot;    rawObject[&#39;doctorRec&#39;] = {&quot;,&quot;      &#39;id&#39;: this.doctorRec.id,&quot;,&quot;        &#39;expirationDate&#39;: {&quot;,&quot;        &#39;iso8601&#39;: this.doctorRec.expirationDate.getIso8601()&quot;,&quot;      },&quot;,&quot;      &#39;state&#39;: this.doctorRec.state,&quot;,&quot;      &#39;country&#39;: this.doctorRec.country || &#39;USA&#39;,&quot;,&quot;      &#39;doctor&#39;: {&quot;,&quot;        &#39;contact&#39;: {},&quot;,&quot;        &#39;name&#39;: {&quot;,&quot;          &#39;firstName&#39;: this.doctorRec.doctorName.getFirstName(),&quot;,&quot;            &#39;lastName&#39;: this.doctorRec.doctorName.getLastName()&quot;,&quot;        }&quot;,&quot;      }&quot;,&quot;    };&quot;,null,&quot;    if (this.doctorRec.doctorWebsite !== null)&quot;,&quot;      rawObject[&#39;doctorRec&#39;][&#39;doctor&#39;][&#39;contact&#39;][&#39;website&#39;] = {&quot;,&quot;        &#39;uri&#39;: this.doctorRec.doctorWebsite&quot;,&quot;      };&quot;,&quot;    if (this.doctorRec.doctorPhone)&quot;,&quot;      rawObject[&#39;doctorRec&#39;][&#39;doctor&#39;][&#39;contact&#39;][&#39;phone&#39;] = {&quot;,&quot;        &#39;phone&#39;: {&#39;e164&#39;: this.doctorRec.doctorPhone}&quot;,&quot;      };&quot;,&quot;  }&quot;,null,&quot;  // copy in user profile&quot;,&quot;  if (this.profile !== null) {&quot;,&quot;    rawObject[&#39;consumerProfile&#39;] = this.profile.serialize();&quot;,&quot;  }&quot;,null,&quot;  // copy in password, if it&#39;s there&quot;,&quot;  if (this.password !== null) rawObject[&#39;password&#39;] = this.password;&quot;,null,&quot;  // copy in doctor website, if it&#39;s there&quot;,&quot;  if (this.dryRun === true)&quot;,&quot;    rawObject[&#39;dryRun&#39;] = true;&quot;,null,&quot;  bloombox.logging.info(&#39;Enrolling user...&#39;,&quot;,&quot;    {&#39;payload&#39;: rawObject, &#39;enrollment&#39;: this});&quot;,null,&quot;  const rpc = new bloombox.shop.rpc.ShopRPC(&quot;,&quot;    /** @type {bloombox.shop.Routine} */ (bloombox.shop.Routine.ENROLL_USER),&quot;,&quot;    &#39;POST&#39;, [&quot;,&quot;      &#39;partners&#39;, partner,&quot;,&quot;      &#39;locations&#39;, location,&quot;,&quot;      &#39;members&#39;].join(&#39;/&#39;), rawObject);&quot;,null,&quot;  let done = false;&quot;,&quot;  let personObj = this.person;&quot;,&quot;  let enrollment = this;&quot;,null,&quot;  rpc.send(function(response) {&quot;,&quot;    if (done) return;&quot;,&quot;    if (response !== null) {&quot;,&quot;      done = true;&quot;,null,&quot;      bloombox.logging.log(&#39;Response received for enrollment RPC.&#39;, response);&quot;,&quot;      let inflated = (&quot;,&quot;        new proto.bloombox.schema.services.shop.v1.EnrollMember.Response());&quot;,&quot;      if (response[&#39;error&#39;]) {&quot;,&quot;        // an error occurred&quot;,&quot;        inflated.setError(response[&#39;error&#39;]);&quot;,&quot;        callback(false, inflated.getError(), null);&quot;,&quot;        enrollment.sendAnalytics(null, null, inflated.getError());&quot;,&quot;      } else {&quot;,&quot;        if (response[&#39;id&#39;] &amp;&amp; response[&#39;foreignId&#39;]) {&quot;,&quot;          // we have a resulting customer object and ID&quot;,&quot;          inflated.setId(response[&#39;id&#39;]);&quot;,&quot;          inflated.setForeignId(response[&#39;foreignId&#39;]);&quot;,null,&quot;          // Notify analytics of the new active user ID.&quot;,&quot;          bloombox.telemetry.notifyUserID(inflated.getId());&quot;,null,&quot;          enrollment.setKey(inflated.getId());&quot;,&quot;          enrollment.setForeignId(inflated.getForeignId());&quot;,&quot;          let customer = new bloombox.shop.Customer(&quot;,&quot;            personObj,&quot;,&quot;            response[&#39;foreignId&#39;]);&quot;,null,&quot;          bloombox.logging.log(&#39;Decoded customer from response.&#39;, customer);&quot;,&quot;          callback(true, null, customer);&quot;,&quot;          enrollment.sendAnalytics(&quot;,&quot;            inflated.getId(), inflated.getForeignId(), null);&quot;,&quot;        } else {&quot;,&quot;          bloombox.logging.error(&quot;,&quot;            &#39;Failed to find customer or ID in response.&#39;,&quot;,&quot;            response);&quot;,&quot;          callback(false, null, null);&quot;,&quot;        }&quot;,&quot;      }&quot;,&quot;    } else {&quot;,&quot;      bloombox.logging.warn(&#39;Failed to inflate RPC.&#39;, response);&quot;,&quot;      callback(false, null, null);&quot;,&quot;      enrollment.sendAnalytics(null, null);&quot;,&quot;    }&quot;,&quot;  }, function(status) {&quot;,&quot;    bloombox.logging.error(status ?&quot;,&quot;      &#39;Enrollment RPC failed with unexpected status: \\&#39;&#39; + status + &#39;\\&#39;.&#39; :&quot;,&quot;        &#39;Enrollment RPC response failed to be decoded.&#39;);&quot;,&quot;    callback(false, null, null);&quot;,&quot;    enrollment.sendAnalytics(null, null, null, status);&quot;,&quot;  });&quot;,&quot;};&quot;]]]"></main><footer><div><a href="https://github.com/jleyba/js-dossier">Generated by dossier</a></div></footer></div><script src="../../../../dossier.js" defer></script>